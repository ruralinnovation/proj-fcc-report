---
title: "EDA on ISP"
date: last-modified
format: 
  html:
    code-fold: true
engine: knitr
---

```{r}
#| label: utility functions
source("R/table_with_options.R")
```

We are starting a first exploratory data analysis around ISPs in the FCC BDC data set. It should be kept in mind that an ISP can be multiple time in the same location (offering multiple service).

We shifted a bit from exploring to try to classify the quality of information we have from FCC about ISP.

The query that generated the data set is here: 

```SQL
select 
    frn,
    provider_id,
    brand_name,
    count(distinct location_id) as cnt_locations,
    count(*) as cnt_locations_services,
    bool_or(case when technology = 10 then true else false end) as has_copperwire,
    bool_or(case when technology = 40 then true else false end) as has_coaxial_cable,
    bool_or(case when technology = 50 then true else false end) as has_fiber,	
    bool_or(case when technology = 71 or  technology = 72 then true else false end) as has_wireless,
    bool_or(case when technology = 60 or  technology = 61 then true else false end) as has_satel,
    array_agg(distinct state_abbr)
from staging.june23
group by frn, provider_id, brand_name
```

The name of the column match FCC [description](https://us-fcc.app.box.com/v/bdc-data-downloads-output). 

We are adding: 

-  `cnt_locations_services`: count of **services**, in one location you can have multiple services with different providers, technology and speeds provides (sometimes one providers can have multiple technology and/or multiple speeds) 

- `cnt_locations`: count of locations covered by this specific set of brand_name, provider_id, state_abbr and technology (here if a provider declare providing different speed in that location it will not be counted) 

- a serie of flag (`has`) telling if this "combo" is proving said technology

- an array listing in which states are present our "combo"


It can be explored here: 


```{r}
#| label: read and display ISP  
isp <- read.csv("data/isp.csv")
# colnames(isp) <- c("brand_name", "state_abbr", "technology",
# "provider_id", "cnt_services", "cnt_total_locations", "cnt_block_presence")

# isp$temp <- paste0(isp$brand_name, isp$provider_id)
# isp <- isp[order(isp$temp),]
# isp$ID <- cumsum(!duplicated(isp$temp))
# isp$ct[!duplicated(isp$ID)] <- 1 
# isp$multiple_name_id <- ave(isp$ct, isp$provider_id, FUN = function(x) sum(x , na.rm = TRUE))
# isp <- isp[,c("ID", "brand_name", "provider_id", "multiple_name_id", "state_abbr", "technology", 
#             "cnt_services", "cnt_total_locations", "cnt_block_presence")]
table_with_options(isp)
```

## Numbers for context: 

```{r}
#|  label: filter sat
# filter_sat <- c(60, 61, 70)
# isp_slim <- isp[! isp$technology %in% filter_sat, ]
```

TODO make a table with number of diff brand_name, frn, provider_id
 
For the rest of the analysis I will not take into account Satellite data and Unlicensed Wireless.

Our first step will be to try having some "unique"  brand name so we can be confident we are correctly counting the same ISP (or not).  

## Organize a bit `brand_name` and `provider_id` 

 ```{r}
 #| label: some cleaning
isp$brand_name <- tolower(isp$brand_name)
 ```

It seems that we have:  
    - brand name with and without capital letter (VERIZON, Verizon)


```{r}
#| label: agg per brand name
# isp_agg <- aggregate(isp_slim["cnt_services"], isp_slim["brand_name"], sum)
# table_with_options(isp_agg[order(isp_agg$cnt_services, decreasing = TRUE), ])
```

I have done a smaller `.csv` just with `brand_name` `provider_id` and `cnt_services` just to inspect what is the relation between them (1 to 1 / 1 to many). Outside of typos we should not have many to many relation. 





